
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <meta name="google-signin-scope" content="profile email https://www.googleapis.com/auth/fitness.body.read">
    <meta name="google-signin-client_id" content="262605754785-dtkb6a01rr39bdf8v2o8hp1b9p77eb68.apps.googleusercontent.com">

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
  </head>
  <body>
    <h1>Hello, world!</h1>
    <div id="results"></div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="js/science.v1.min.js"></script>
    <!-- <script src="js/loess.js"></script> -->


    <div class="g-signin2"></div>
    <script>

    // function onSuccess(googleUser) {
    //   console.log('Logged in as: ' + googleUser.getBasicProfile().getName());
    // }
    // function onFailure(error) {
    //   console.log(error);
    // }
    // function renderButton() {
    //   gapi.signin2.render('my-signin2', {
    //         'scope': 'profile email fitness.body.read',
    //         'width': 240,
    //         'height': 50,
    //         'longtitle': true,
    //         'theme': 'dark',
    //         'onsuccess': onSuccess,
    //         'onfailure': onFailure
    //   });
    // }

    function onSignIn(googleUser) {
      var profile = googleUser.getBasicProfile();
      console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
      console.log('Name: ' + profile.getName());
      console.log('Image URL: ' + profile.getImageUrl());
      console.log('Email: ' + profile.getEmail());

      var access_token = googleUser.getAuthResponse().access_token;
      console.log("ID Token: " + access_token);

      // gapi.client.request("https://www.googleapis.com/fitness/v1/users/me/dataSources/derived:com.google.weight:com.google.android.gms:merge_weight/datasets/0-1484461008")
    }
    </script>
    <!-- <script>
      gapi.auth2.init();
    </script> -->
    <!-- <script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script> -->


    <a href="#" onclick="signOut();">Sign out</a>
    <script>
      function signOut() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function () {
          console.log('User signed out.');
        });
      }
    </script>

    <button type="button" class="btn btn-default btn-lg" onclick="getData();">
      <span class="glyphicon glyphicon-stats" aria-hidden="true"></span> Get Data
    </button>
    <div id=vis></div>

    <script>
    var weight_sources;
    var curr_time = (Math.floor(Date.now() / 1000)+31536000) * 1000000000;

    function start() {
      // 2. Initialize the JavaScript client library.
      gapi.client.request("https://www.googleapis.com/fitness/v1/users/me/dataSources?dataTypeName=com.google.weight")
        .then(function(response) {
          weight_sources = response.result;
          idlist = [];
          for (el in weight_sources.dataSource){
            streamId = weight_sources.dataSource[el].dataStreamId;
            if (streamId == "derived:com.google.weight:com.google.android.gms:merge_weight") {
              idlist = [streamId];
              break;
            } else {
              idlist.push(streamId);
            }
          }
          Promise.all(idlist.map(getDataFromStream)).then(function(values){
            var data = extractDataFromStreams(values);
            for (el in data) {
              // Extract data from JSON object and convert kg to pounds
              data[el] = [new Date(+data[el].endTimeNanos/1000000), data[el].value[0].fpVal*2.20462];
            }
            console.log(data);
            makeGraph(data);
          });
      }, function(reason) {
        console.log('Error: ' + reason.result.error.message);
      });
    };
    // 1. Load the JavaScript client library.
    function getData() {
      gapi.load('client', start);
    }
    function getDataFromStream(streamId) {
      console.log("https://www.googleapis.com/fitness/v1/users/me/dataSources/"+streamId+"/datasets/0-"+curr_time);
      return gapi.client.request("https://www.googleapis.com/fitness/v1/users/me/dataSources/"+streamId+"/datasets/0-"+curr_time);
    }
    function extractDataFromStreams(streams) {
      var data = [];
      for (stream in streams) {
        var curr = streams[stream].result.point;
        if (curr.length > data.length) {
          data = curr;
        }
      }

      return data;
    }

    function makeGraph(data){
      // Based on https://github.com/jasondavies/science.js/blob/master/examples/loess/loess.js

      var w = 960,
          h = 500,
          p = 35.5,
          n = 100,
          x = d3.scaleTime().domain([new Date(data[0][0]-86400000), new Date(data[data.length-1][0]+86400000)]).range([0, w]),
          y = d3.scaleLinear().domain([160,220]).range([h, 0]);

      var xAxis = d3.axisBottom(x),
          yAxis = d3.axisLeft(y);

      var vis = d3.select("#vis")
        .append("svg")
          .attr("width", w + p + p)
          .attr("height", h + p + p)
        .append("g")
          .attr("transform", "translate(" + p + "," + p + ")");

      var min_band = 2/data.length;

      var loess = science.stats.loess().bandwidth(d3.max([min_band, .8]));

      var zipped_data = d3.transpose(data);
      var loess_result = loess(zipped_data[0], zipped_data[1]);
      console.log("loess", loess_result);
      zipped_data[1] = loess_result.loess;
      zipped_data.push(loess_result.confint);
      data = d3.zip(zipped_data[0], zipped_data[1], zipped_data[2]);

      var area = d3.area()
            .x(function(d) { return x(d[0]); })
            .y0(function(d) { return d[2] ? y(d[1]-d[2]) : y(d[1]);})
            .y1(function(d) { return d[2] ? y(d[1]+d[2]) : y(d[1]);});


      vis.selectAll("path")
          .data([data])
        .enter().append("path")
          .attr("d", function(d){return area(d);})
          .attr("stroke", "black")
          .attr("fill", "purple")
          .attr("stroke-width", 1);

      vis.append("g")
          .attr("class", "bottom axis")
          .attr("transform", "translate(0," + h + ")")
          .call(xAxis);

      vis.append("g")
          .attr("class", "left axis")
          .call(yAxis);
    }
    </script>

  </body>
</html>
